<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>热区图</title>
  <style>
    * {
      margin: 0;
      padding: 0;
    }

    body {
      padding: 0px;
      width: 100vw;
      height: 100vh;
      box-sizing: border-box;
    }

    div.img {
      width: 100%;
      height: 100%;
      position: relative;
    }

    div.img .mark {
      display: none;
      background: rgba(255, 0, 0, .2);
      position: absolute;
      top: 0;
      left: 0;
      /* 鼠标事件穿透 */
      pointer-events: none;
    }

    img {
      display: block;
      width: 100%;
      height: 100%;
    }
  </style>
</head>

<body>
  <!-- Image Map Generated by http://www.image-map.net/ -->
  <div class="img">
    <div class="mark" name="image-map"></div>
    <img src="https://shalashike.oss-cn-shenzhen.aliyuncs.com/APK广告/2023/06/28/5688ba839b7146a4b20eaac39726a4d51.jpg" usemap="#image-map">
  </div>

  <map name="image-map" width="1920" height="1080">
    <!-- 手上的鱼图形 -->
    <area target="_blank" alt="跳转百度" title="跳转百度" href="https://www.baidu.com" data-coords="940,122,862,185,847,227,820,246,793,259,764,315,813,336,854,332,889,363,928,370,972,359,916,342,905,319,939,295,984,317,1030,327,1047,326,1022,271,1027,193,986,214,947,254,928,254,905,251,922,222,925,197,920,164" shape="poly">
    <!-- 左边人脸 -->
    <area target="_blank" alt="跳转搜狐" title="跳转搜狐" href="https://www.sohu.com/" data-coords="367,224,204" shape="circle">
    <!-- 右边人脸 -->
    <area target="_blank" alt="跳转bilibili" title="跳转bilibili" href="https://www.bilibili.com/" data-coords="1586,181,1750,349" shape="rect">
  </map>

  <script>
    //初始数据保存
    let initarea = {};

    // 获取指定热区的坐标
    function getCoords (area) {
      /**
       * 判断当前热区是否存在
       * coords：原始坐标数据
       * now_coords：自适应后的坐标数据
      */
      let obj = { dom: area, coords: [], now_coords: [] };

      // 坐标字符串
      let coordinate = area.dataset['coords'];

      // 当前图形类型
      let shape = area.getAttribute('shape');

      // 判断如果是矩形或者多边形，就将每个点的坐标区分开来(x1, y1, x2, y2, x3, y3......xn, yn)
      if (["rect", "poly"].includes(shape)) {
        var arr = coordinate.split(',');
        // 判断有多少个坐标
        let num = Math.floor(arr.length / 2);
        // 提取每个坐标
        for (let index = 0; index < num; index++) {
          /**
           * index为第几个坐标，index * 2为当前坐标的X轴坐标在坐标列表中的位置
           * index * 2 + 1为当前坐标的Y轴坐标在坐标列表中的位置
           * index需要乘以2是因为在坐标列表中，x轴和y轴坐标是相邻的,每两个数据为一个坐标
          */
          // 当前坐标的x轴在坐标列表中的位置，后面一个就是y轴坐标
          let x = arr[index * 2];
          let y = arr[index * 2 + 1];
          obj.coords.push({ x: Number(x), y: Number(y) });
        }

      } else if (["circle"].includes(shape)) {
        // 圆形
        // 当shape属性为circle时，代表相关区域为圆形，则cooreds属性值为(x,y,radius),其中x,y为圆形的中心坐标，radius为圆形的半径
        obj.coords = coordinate.split(',');
      }

      return obj;
    }

    // 给指定热区绑定鼠标事件
    function setAreaFn (area, areaData) {
      /**
       * area:热区元素
       * areaData:热区数据
      */

      // 鼠标在元素中移动监听
      // area.addEventListener('mousemove', function (e) {
      //   // console.log('在热区中移动', e);
      //   // 热区所属map
      //   let map = e.target.parentElement;
      //   // 热区所属名称
      //   const mapName = map.getAttribute('name');
      //   // 热区所属图片元素
      //   const img = document.querySelector(`img[usemap='#${mapName}']`);
      //   // 热区所属图片参数
      //   const rect = img.getBoundingClientRect();
      //   // 热区所属遮罩
      //   let mark = document.querySelector(`div[name='${mapName}']`);

      //   // 鼠标相对于图片位置
      //   const x = e.clientX - rect.left;
      //   const y = e.clientY - rect.top;

      //   mark.style.top = (y - 50) + 'px';
      //   mark.style.left = (x - 50) + 'px';
      //   mark.style.display = 'block';
      // });

      // 鼠标移入事件
      area.addEventListener('mouseover', function (e) {
        console.log('进入热区', e);
        // 热区所属map
        let map = e.target.parentElement;
        // 热区所属名称
        const mapName = map.getAttribute('name');
        // 热区所属图片元素
        const img = document.querySelector(`img[usemap='#${mapName}']`);
        // 热区所属图片参数
        const rect = img.getBoundingClientRect();
        // 热区所属遮罩
        let mark = document.querySelector(`div[name='${mapName}']`);
        // 当前图形类型
        let shape = e.target.getAttribute('shape');

        // 显示遮罩
        mark.style.display = 'block';

        // 判断是否为矩形或者多边形
        if (["rect", "poly"].includes(shape)) {

          // 绘制多边形
          let x_list = [];//多边形x轴数据列表
          let y_list = [];//多边形Y轴数据列表
          areaData.now_coords.forEach(t => {
            x_list.push(t.x);
            y_list.push(t.y);
          });

          // 获取图形X轴最大最小值
          let max_x = Math.max(...x_list);
          let min_x = Math.min(...x_list);

          // 获取图形y轴最大最小值
          let max_y = Math.max(...y_list);
          let min_y = Math.min(...y_list);

          //图形的x，y轴最大值-最小值就是图形的宽高
          let m_w = max_x - min_x;
          let m_h = max_y - min_y;

          // 设置大小
          mark.style.width = `${m_w}px`;
          mark.style.height = `${m_h}px`;

          // 设置浮动位置
          mark.style.left = `${min_x}px`;
          mark.style.top = `${min_y}px`;

          // 绘制多边形
          if (["poly"].includes(shape)) {
            let coords = areaData.now_coords.map(t => {
              // 多边形坐标位置减去x,y轴的最小值，如此多边形的最右边与最上边就贴边了，没有多余的空白
              let x = t.x - min_x;
              let y = t.y - min_y;
              // return `${x}px ${y}px`;

              // 计算为百分比制(坐标的x,y轴的值/多边形所属元素的宽高*100)
              x = x / m_w * 100;
              y = y / m_h * 100;
              return `${x}% ${y}%`;
            });

            mark.style.clipPath = `polygon(${coords.join(',')})`;
          } else {
            mark.style.clipPath = '';
          }

        } else if (["circle"].includes(shape)) {
          // 绘制圆形
          let data = areaData.now_coords;
          let x = data[0].x;//圆心x轴坐标
          let y = data[1].y;//圆心y轴坐标
          let radius = data[2].radius;//最大宽高比的圆半径
          let x_radius = data[2].x_radius;//x轴的圆半径
          let y_radius = data[2].y_radius;//y轴的圆半径

          // 绘制圆
          {
            // 遮罩的宽，圆的半径 * 2;
            let w = radius * 2;
            // 遮罩的高
            let h = radius * 2;

            // 设置大小
            mark.style.width = `${w}px`;
            mark.style.height = `${h}px`;

            // 设置浮动位置，
            mark.style.left = `${x - (w / 2)}px`;
            mark.style.top = `${y - (h / 2)}px`;

            mark.style.clipPath = `circle(${radius}px at 50% 50%)`;
          }

          // 绘制椭圆
          // {
          //   // 遮罩的宽，圆的半径 * 2;
          //   let w = x_radius * 2;
          //   // 遮罩的高
          //   let h = y_radius * 2;

          //   // 设置大小
          //   mark.style.width = `${w}px`;
          //   mark.style.height = `${h}px`;

          //   // 设置浮动位置，
          //   mark.style.left = `${x - (w / 2)}px`;
          //   mark.style.top = `${y - (h / 2)}px`;

          //   mark.style.clipPath = `ellipse(${x_radius}px ${y_radius}px at 50% 50%)`;
          // }
        }
      });

      // 鼠标移出事件
      area.addEventListener('mouseout', function (e) {
        console.log('退出热区', e);
        // 热区所属map
        let map = e.target.parentElement;
        // 热区所属名称
        const mapName = map.getAttribute('name');
        // 热区所属图片元素
        const img = document.querySelector(`img[usemap='#${mapName}']`);
        // 热区所属图片参数
        const rect = img.getBoundingClientRect();
        // 热区所属遮罩
        let mark = document.querySelector(`div[name='${mapName}']`);

        mark.style.display = 'none';
      });
    }

    //初始化
    function init (name = 'image-map') {
      // 热区图片
      let img = document.querySelector(`img[usemap='#${name}']`);
      // 热区坐标组
      let map = document.querySelector(`map[name='${name}']`);
      // 热区坐标列表
      let areas = map.querySelectorAll('area');
      if (img.complete) { // 检查图片是否已经加载完成
        console.log('加载已完成');
        console.log('图片实际宽度:', img.naturalWidth);
        console.log('图片实际高度:', img.naturalHeight);
      } else {
        img.onload = function () {
          console.log('图片实际宽度:', this.naturalWidth);
          console.log('图片实际高度:', this.naturalHeight);
        };
      }

      // 获取所有热区坐标
      Array.from(areas).forEach((t, i) => {
        // 计算热区坐标
        let obj = getCoords(t);
        if (!initarea[name]) initarea[name] = [];
        initarea[name].push(obj);
        // 给热区绑定鼠标事件
        setAreaFn(t, obj);
        // 创建计算比例后的真实热区坐标
        setCoords(t);
      })
    }

    //根据分辨率自适应热区坐标
    function setCoords (area) {
      // 热区所属map
      const map = area.parentElement;
      // 热区所属名称
      const mapName = map.getAttribute('name');
      // 热区所属图片元素
      const img = document.querySelector(`img[usemap='#${mapName}']`);
      // 热区所属图片参数
      const img_data = img.getBoundingClientRect();
      // 热区所属遮罩
      const mark = document.querySelector(`div[name='${mapName}']`);
      // 当前热区数据对象
      const row = initarea[mapName].filter(t => t.dom.alt == area.alt)[0];

      // 当前图片宽度
      const width = img_data.width;
      // 当前图片高度
      const height = img_data.height;
      // 图片初始热区坐标对应初始宽度
      const initwidth = map.getAttribute('width');
      // 图片初始热区坐标对应初始高度
      const initHeight = map.getAttribute('height');
      // 当前图片宽度与初始宽度比
      const percent_w = width / initwidth;
      // 当前图片高度与初始高度比
      const percent_h = height / initHeight;

      let str = '';
      // 当前图形类型
      let shape = area.getAttribute('shape');
      // 循环坐标列表，得到自适应后的坐标组
      row.now_coords = (row.coords || []).map((c, i) => {
        let data = {};
        // 判断是否为矩形或者多边形
        if (["rect", "poly"].includes(shape)) {
          let x = c.x * percent_w;
          let y = c.y * percent_h;
          str += `${x},${y},`;
          data = { x, y };
        } else if (["circle"].includes(shape)) {
          // 圆形
          // 圆心X坐标
          if (i == 0) {
            let x = c * percent_w;
            str += `${x},`;
            data.x = x;
          }
          // 圆心Y坐标
          else if (i == 1) {
            let y = c * percent_h;
            str += `${y},`;
            data.y = y;
          }
          // 圆半径
          else if (i == 2) {
            // 使用最大的宽高比值
            let radius = c * (percent_w > percent_h ? percent_h : percent_w);
            // x轴的圆半径
            let x_radius = c * percent_w;
            // y轴的圆半径
            let y_radius = c * percent_h;
            str += `${radius},`;
            data.radius = radius;// 最大宽高比的圆半径
            data.x_radius = x_radius;//x轴的圆半径
            data.y_radius = y_radius;//y轴的圆半径
          }
        }
        return data;
      });

      area.setAttribute("coords", str.substring(0, str.length - 1));
    }

    // 判断点是否在多边形内
    function pointInPolygon (point, polygon) {
      /**
       * 判断一个点是否位于多边形内部。
       * 使用射线法，从点向任意方向引一条射线，统计射线与多边形边界的交点数量。
       * 如果交点数量为奇数，则点在多边形内部；如果为偶数，则点在多边形外部。
       * 
       * @param {Object} point 包含x和y属性的对象，表示待检测的点的坐标。
       * @param {Array} polygon 包含多个顶点的对象数组，每个顶点也是一个包含x和y属性的对象，表示多边形的轮廓。
       * @returns {boolean} 如果点在多边形内部返回true，否则返回false。
       */
      let x = point.x;
      let y = point.y;
      let arr = [...polygon];

      // 判断多边形是否是闭合的，如果不是就手动处理闭合
      let startData = arr[0];
      let lastData = arr[arr.length - 1];
      if (startData.x != lastData.x || startData.y != lastData.y) {
        arr.push(startData);
      }

      // 初始化点在多边形外部的标志
      // 射线法判断点是否在多边形内
      var inside = false;

      // 遍历多边形的每条边，判断射线与边的交点情况
      polygon.forEach((t, i) => {
        let j = i - 1;
        if (j < 0) j = polygon.length - 1;

        var xi = polygon[i].x, yi = polygon[i].y;
        var xj = polygon[j].x, yj = polygon[j].y;

        // 判断当前边是否与射线交点，并根据交点情况翻转inside的值
        var intersect = ((yi > y) != (yj > y)) && (x < (xj - xi) * (y - yi) / (yj - yi) + xi);
        if (intersect) inside = !inside;
      })

      // 返回点是否在多边形内部的结果
      return inside;
    }

    // 鼠标在元素中移动监听
    document.querySelector('img').addEventListener('mousemove', function (e) {
      // 热区所属图片元素
      const img = document.querySelector('img');
      // 热区所属图片参数
      const rect = img.getBoundingClientRect();

      // 鼠标相对于图片位置
      const x = e.clientX - rect.left;
      const y = e.clientY - rect.top;

      // 循环每一个热区
      let row = null;
      let initareaList = Object.entries(initarea);
      let is = initareaList.some(t => {
        return t[1].some(f => {
          let s = pointInPolygon({ x, y }, f.now_coords);
          if (s) row = f;
          return s;
        })
      })
      console.log('是否在多边形', is);
      if (is) {
        // 鼠标在热区内
        console.log('热区属性', row);
      }
    });

    //初始化
    init();

    window.onresize = function () {
      // 热区坐标列表
      let areas = document.querySelectorAll('area');
      // 获取所有热区坐标
      Array.from(areas).forEach((t, i) => {
        // 创建计算比例后的真实热区坐标
        setCoords(t);
      })
    } 
  </script>
</body>

</html>